import{c as L,s as I,r as d,u as T,j as e,B as x}from"./index-Cfyb-cTT.js";import{I as $,A,a as B}from"./input-DI_PInR2.js";import{L as C}from"./label-KRVLd3Sf.js";import{T as R}from"./textarea-Br_aITBP.js";import{C as D,c as H}from"./index-lOgDGn8a.js";import{L as P}from"./Layout-Bu6kW370.js";import{f as U}from"./emailUtils-C-rUDXQT.js";import{A as V}from"./arrow-left-CK-CAtYp.js";import{C as E}from"./camera-CDeARvGO.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=L("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]),M=async(n,f,m,c)=>{try{let o="",i="";if(c){const t=new FileReader;o=await new Promise((y,N)=>{t.onload=()=>{const w=t.result;y(w.split(",")[1])},t.onerror=N,t.readAsDataURL(c)}),i=c.name}const b=`Báo lỗi ứng dụng từ ${f} (${n})`,g=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2 style="color: #dc2626; text-align: center;">Báo lỗi ứng dụng Thông báo TS</h2>
        <div style="background-color: #fef2f2; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #dc2626;">
          <h3 style="color: #dc2626; margin-top: 0;">Thông tin người báo lỗi:</h3>
          <p><strong>Username:</strong> ${n}</p>
          <p><strong>Họ tên:</strong> ${f}</p>
          <p><strong>Email:</strong> ${U(n)}</p>
          <p><strong>Thời gian:</strong> ${new Date().toLocaleString("vi-VN")}</p>
        </div>
        <div style="background-color: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <h3 style="color: #374151; margin-top: 0;">Nội dung lỗi:</h3>
          <p style="white-space: pre-wrap; background-color: #ffffff; padding: 15px; border-radius: 4px; border: 1px solid #e5e7eb;">${m}</p>
        </div>
        ${c?`
          <div style="background-color: #f0f9ff; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="color: #0369a1; margin-top: 0;">Hình ảnh đính kèm:</h3>
            <p><strong>Tên file:</strong> ${i}</p>
            <p><em>Hình ảnh được đính kèm trong email này.</em></p>
          </div>
        `:""}
        <p style="color: #6b7280; font-size: 14px; text-align: center; margin-top: 30px;">
          Email tự động từ hệ thống Thông báo TS
        </p>
      </div>
    `,h={to:["dongnv.hvu@vietcombank.com.vn","ngviendong@gmail.com"],subject:b,html:g,type:"error_report"};o&&i&&(h.attachments=[{filename:i,content:o,encoding:"base64"}]),console.log("Sending error report email:",h);const{data:a,error:l}=await I.functions.invoke("send-notification-email",{body:h});if(console.log("Error report email response:",{data:a,error:l}),l)throw console.error("Error report email error:",l),new Error(`Lỗi gửi báo lỗi: ${l.message}`);if(a&&!a.success)throw console.error("Error report email service error:",a.error),new Error(`Lỗi từ dịch vụ email: ${a.error}`);return console.log("Error report email sent successfully:",a),{success:!0,data:a,message:"Báo lỗi đã được gửi thành công"}}catch(o){return console.error("Error in sendErrorReport:",o),{success:!1,error:o instanceof Error?o.message:"Lỗi không xác định",message:"Không thể gửi báo lỗi"}}},Q=()=>{const[n,f]=d.useState(null),[m,c]=d.useState(""),[o,i]=d.useState(null),[b,g]=d.useState(null),[h,a]=d.useState(!1),[l,t]=d.useState({type:"",text:""}),y=T();d.useEffect(()=>{const r=localStorage.getItem("loggedInStaff");r&&f(JSON.parse(r))},[]);const N=r=>{var p;const s=(p=r.target.files)==null?void 0:p[0];if(s){if(!s.type.startsWith("image/")){t({type:"error",text:"Vui lòng chọn file hình ảnh"});return}if(s.size>10*1024*1024){t({type:"error",text:"Vui lòng chọn file nhỏ hơn 10MB"});return}i(s);const u=new FileReader;u.onload=v=>{var j;return g((j=v.target)==null?void 0:j.result)},u.readAsDataURL(s)}},w=()=>{const r=document.createElement("input");r.type="file",r.accept="image/*",r.capture="environment",r.multiple=!1,r.onchange=s=>{const p=s.target.files;if(p&&p.length>0){const u=p[0];i(u);const v=new FileReader;v.onload=j=>{var k;return g((k=j.target)==null?void 0:k.result)},v.readAsDataURL(u)}},r.click()},S=async r=>{if(r.preventDefault(),t({type:"",text:""}),!m.trim()){t({type:"error",text:"Vui lòng nhập nội dung báo lỗi"});return}if(!n){t({type:"error",text:"Không tìm thấy thông tin người dùng"});return}a(!0);try{const s=await M(n.username,n.staff_name,m,o);s.success?(t({type:"success",text:"Báo lỗi đã được gửi thành công. Chúng tôi sẽ xem xét và phản hồi sớm nhất."}),c(""),i(null),g(null),setTimeout(()=>y("/asset-entry"),2e3)):t({type:"error",text:s.error||"Có lỗi xảy ra khi gửi báo lỗi"})}catch{t({type:"error",text:"Có lỗi xảy ra khi gửi báo lỗi"})}finally{a(!1)}};return e.jsx(P,{children:e.jsxs("div",{className:"max-w-2xl mx-auto space-y-6 p-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(x,{variant:"ghost",onClick:()=>y("/asset-entry"),className:"p-2",children:e.jsx(V,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Thông báo lỗi ứng dụng"}),e.jsx("p",{className:"text-gray-600",children:"Báo cáo lỗi và gửi hình ảnh minh họa"})]})]}),e.jsx(D,{children:e.jsx(H,{className:"space-y-6 p-6",children:e.jsxs("form",{onSubmit:S,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{className:"text-base font-semibold",children:"Người gửi"}),e.jsx($,{value:(n==null?void 0:n.username)||"",disabled:!0,className:"bg-gray-100"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{className:"text-base font-semibold",children:"Nội dung báo lỗi"}),e.jsx(R,{value:m,onChange:r=>c(r.target.value),placeholder:"Nhập sơ bộ lỗi và ấn nút gửi hình ảnh bên dưới.",className:"min-h-32",required:!0})]}),b&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{className:"text-base font-semibold",children:"Hình ảnh đính kèm"}),e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsx("img",{src:b,alt:"Preview",className:"max-w-full h-auto max-h-64 mx-auto rounded"}),e.jsx(x,{type:"button",variant:"outline",onClick:()=>{i(null),g(null)},className:"mt-2 text-red-600",children:"Xóa hình ảnh"})]})]}),l.text&&e.jsx(A,{variant:l.type==="error"?"destructive":"default",className:l.type==="success"?"bg-green-100 border-green-400 text-green-800":"",children:e.jsx(B,{children:l.text})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(x,{type:"button",variant:"outline",onClick:w,className:"text-green-600 border-green-200 hover:bg-green-50",children:[e.jsx(E,{className:"w-4 h-4 mr-2"}),"Chụp ảnh"]}),e.jsxs(x,{type:"button",variant:"outline",onClick:()=>{var r;return(r=document.getElementById("image-upload"))==null?void 0:r.click()},className:"text-green-600 border-green-200 hover:bg-green-50",children:[e.jsx(E,{className:"w-4 h-4 mr-2"}),"Chọn ảnh"]}),e.jsx("input",{id:"image-upload",type:"file",accept:"image/*",className:"hidden",onChange:N})]}),e.jsx(x,{type:"submit",disabled:h||!m.trim(),className:"bg-red-600 hover:bg-red-700",children:h?"Đang gửi...":e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"Gửi báo lỗi"]})})]})]})})})]})})};export{Q as default};
