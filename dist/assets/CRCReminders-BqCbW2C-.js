import{r as o,s as a,d as I,j as e,B as v}from"./index-Cfyb-cTT.js";import{I as ce,A as je,a as be}from"./input-DI_PInR2.js";import{L as E}from"./label-KRVLd3Sf.js";import{C as M,a as U,b as X,c as H}from"./index-lOgDGn8a.js";import{T as re,L as Re}from"./Layout-Bu6kW370.js";import{b as _e}from"./assetNotificationService-Rh4JThwE.js";import{C as Ne,D as ve,a as z}from"./ComboBox-C74QWB7N.js";import{T as se,a as ne,b as L,c as C,d as ae,e as h}from"./table-B3C0REyg.js";import{C as le}from"./circle-alert-XyUDaGPe.js";import{M as we}from"./mail-7Z1xUE3J.js";import{S as Se}from"./square-pen-PhqW0fJJ.js";import{i as O}from"./dateUtils-GKxu_fIk.js";import{s as qe}from"./notificationService-74P8wsMt.js";import"./emailUtils-C-rUDXQT.js";import"./format-CaiECi-v.js";import"./addDays-ggkpGDyJ.js";const Te=()=>{const[l,d]=o.useState({staff:{ldpcrc:[],cbcrc:[],quycrc:[]},reminders:[],sentReminders:[],isLoading:!1,error:null}),y=o.useCallback(async()=>{var r,n,j,S,q;console.log("üîÑ Starting CRC data load with new open policies..."),d(u=>({...u,isLoading:!0,error:null}));try{const[u,b,R,w,p]=await Promise.all([a.from("ldpcrc").select("*").order("ten_nv"),a.from("cbcrc").select("*").order("ten_nv"),a.from("quycrc").select("*").order("ten_nv"),a.from("crc_reminders").select("*").order("ngay_thuc_hien"),a.from("sent_crc_reminders").select("*").order("sent_date",{ascending:!1})]);console.log("üìä Data load results:",{ldpcrc:{error:u.error,count:((r=u.data)==null?void 0:r.length)||0},cbcrc:{error:b.error,count:((n=b.data)==null?void 0:n.length)||0},quycrc:{error:R.error,count:((j=R.data)==null?void 0:j.length)||0},reminders:{error:w.error,count:((S=w.data)==null?void 0:S.length)||0},sentReminders:{error:p.error,count:((q=p.data)==null?void 0:q.length)||0}});const s=[u.error,b.error,R.error,w.error,p.error].filter(Boolean);if(s.length>0)throw console.error("‚ùå Errors loading data:",s),new Error(`L·ªói t·∫£i d·ªØ li·ªáu: ${s.map(B=>B.message).join(", ")}`);const N={ldpcrc:u.data||[],cbcrc:b.data||[],quycrc:R.data||[]},T=w.data||[],$=p.data||[];console.log("‚úÖ Successfully loaded CRC data:",{totalStaff:N.ldpcrc.length+N.cbcrc.length+N.quycrc.length,reminders:T.length,sentReminders:$.length}),d({staff:N,reminders:T,sentReminders:$,isLoading:!1,error:null})}catch(u){console.error("üí• Critical error loading CRC data:",u);const b=u instanceof Error?u.message:"L·ªói kh√¥ng x√°c ƒë·ªãnh";d(R=>({...R,isLoading:!1,error:b})),I.error(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu CRC: ${b}`)}},[]),g=o.useCallback(()=>(console.log("üîÑ Refreshing CRC data..."),y()),[y]),_=o.useCallback(async()=>{console.log("üîç Testing database connections with new policies...");try{const r=[{name:"ldpcrc",query:a.from("ldpcrc").select("count")},{name:"cbcrc",query:a.from("cbcrc").select("count")},{name:"quycrc",query:a.from("quycrc").select("count")},{name:"crc_reminders",query:a.from("crc_reminders").select("count")},{name:"sent_crc_reminders",query:a.from("sent_crc_reminders").select("count")}],n=await Promise.all(r.map(j=>j.query));r.forEach((j,S)=>{const q=n[S];q.error?console.error(`‚ùå ${j.name} connection error:`,q.error):console.log(`‚úÖ ${j.name} connection OK`)}),I.info("Ki·ªÉm tra console ƒë·ªÉ xem chi ti·∫øt")}catch(r){console.error("üí• Connection test failed:",r),I.error("Ki·ªÉm tra console ƒë·ªÉ xem l·ªói")}},[]);return{...l,loadAllData:y,refreshData:g,testConnection:_}},$e=({filteredReminders:l,isLoading:d,isDayMonthDueOrOverdue:y,onSendSingleReminder:g,onEdit:_,onDelete:r})=>d?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-600"})}):e.jsxs(se,{children:[e.jsx(ne,{children:e.jsxs(L,{children:[e.jsx(C,{children:"Lo·∫°i BT CRC"}),e.jsx(C,{children:"Ng√†y th·ª±c hi·ªán"}),e.jsx(C,{children:"LDPCRC"}),e.jsx(C,{children:"CBCRC"}),e.jsx(C,{children:"QUY√áRC"}),e.jsx(C,{children:"Thao t√°c"})]})}),e.jsxs(ae,{children:[l.map(n=>e.jsxs(L,{children:[e.jsx(h,{className:"font-medium",children:n.loai_bt_crc}),e.jsxs(h,{className:`${y(n.ngay_thuc_hien)?"bg-red-100 text-red-800 font-bold":""}`,children:[n.ngay_thuc_hien,y(n.ngay_thuc_hien)&&e.jsx(le,{className:"w-4 h-4 inline ml-2 text-red-600"})]}),e.jsx(h,{children:n.ldpcrc||"Ch∆∞a ch·ªçn"}),e.jsx(h,{children:n.cbcrc||"Ch∆∞a ch·ªçn"}),e.jsx(h,{children:n.quycrc||"Ch∆∞a ch·ªçn"}),e.jsx(h,{children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(v,{size:"sm",variant:"outline",onClick:()=>g(n),disabled:!y(n.ngay_thuc_hien)||d,title:"G·ª≠i email nh·∫Øc nh·ªü CRC",children:e.jsx(we,{className:"w-4 h-4"})}),e.jsx(v,{size:"sm",variant:"outline",onClick:()=>_(n),disabled:d,children:e.jsx(Se,{className:"w-4 h-4"})}),e.jsx(v,{size:"sm",variant:"destructive",onClick:()=>r(n.id),disabled:d,children:e.jsx(re,{className:"w-4 h-4"})})]})})]},n.id)),l.length===0&&e.jsx(L,{children:e.jsx(h,{colSpan:6,className:"text-center py-8 text-gray-500",children:"Ch∆∞a c√≥ nh·∫Øc nh·ªü n√†o"})})]})]}),De=({filteredSentReminders:l,sentSearchTerm:d,setSentSearchTerm:y,isLoading:g,onDeleteSentReminder:_})=>g?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-600"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-4",children:e.jsx(ce,{placeholder:"T√¨m ki·∫øm trong danh s√°ch ƒë√£ g·ª≠i...",value:d,onChange:r=>y(r.target.value),className:"max-w-sm"})}),e.jsxs(se,{children:[e.jsx(ne,{children:e.jsxs(L,{children:[e.jsx(C,{children:"Lo·∫°i BT CRC"}),e.jsx(C,{children:"Ng√†y th·ª±c hi·ªán"}),e.jsx(C,{children:"LDPCRC"}),e.jsx(C,{children:"CBCRC"}),e.jsx(C,{children:"QUY√áRC"}),e.jsx(C,{children:"Ng√†y g·ª≠i"}),e.jsx(C,{children:"Thao t√°c"})]})}),e.jsxs(ae,{children:[l.map(r=>e.jsxs(L,{children:[e.jsx(h,{className:"font-medium",children:r.loai_bt_crc}),e.jsx(h,{children:r.ngay_thuc_hien}),e.jsx(h,{children:r.ldpcrc||"Ch∆∞a ch·ªçn"}),e.jsx(h,{children:r.cbcrc||"Ch∆∞a ch·ªçn"}),e.jsx(h,{children:r.quycrc||"Ch∆∞a ch·ªçn"}),e.jsx(h,{children:r.sent_date}),e.jsx(h,{children:e.jsx(v,{size:"sm",variant:"destructive",onClick:()=>_(r.id),title:"X√≥a nh·∫Øc nh·ªü ƒë√£ g·ª≠i",disabled:g,children:e.jsx(re,{className:"w-4 h-4"})})})]},r.id)),l.length===0&&e.jsx(L,{children:e.jsx(h,{colSpan:7,className:"text-center py-8 text-gray-500",children:"Ch∆∞a c√≥ email n√†o ƒë∆∞·ª£c g·ª≠i"})})]})]})]}),Ye=()=>{const{staff:l,reminders:d,sentReminders:y,isLoading:g,loadAllData:_,refreshData:r}=Te(),[n,j]=o.useState(null),[S,q]=o.useState(""),[u,b]=o.useState(""),[R,w]=o.useState(null),[p,s]=o.useState({type:"",text:""}),[N,T]=o.useState(""),[$,B]=o.useState(""),[Y,K]=o.useState(""),[G,P]=o.useState(""),[V,A]=o.useState("");o.useEffect(()=>{ie(),_()},[_]);const ie=async()=>{try{const t=localStorage.getItem("currentUser");t&&j(JSON.parse(t))}catch(t){console.error("Error loading current user:",t)}},oe=async t=>{if(t.preventDefault(),s({type:"",text:""}),!N||!$){s({type:"error",text:"Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc"});return}try{const c=i=>{var f;return i?(f=(i.match(/^(.+?)\s*\(/)||[null,i])[1])==null?void 0:f.trim():null},m={loai_bt_crc:N,ngay_thuc_hien:$,ldpcrc:c(Y),cbcrc:c(G),quycrc:c(V),is_sent:!1};if(R){const{error:i}=await a.from("crc_reminders").update(m).eq("id",R.id);if(i)throw i;s({type:"success",text:"C·∫≠p nh·∫≠t nh·∫Øc nh·ªü CRC th√†nh c√¥ng"})}else{const{error:i}=await a.from("crc_reminders").insert([m]);if(i)throw i;s({type:"success",text:"Th√™m nh·∫Øc nh·ªü CRC th√†nh c√¥ng"})}J(),r()}catch(c){s({type:"error",text:`Kh√¥ng th·ªÉ l∆∞u nh·∫Øc nh·ªü CRC: ${c.message}`})}},J=()=>{T(""),B(""),K(""),P(""),A(""),w(null)},he=t=>{w(t),T(t.loai_bt_crc),B(t.ngay_thuc_hien);const c=(m,i)=>{if(!m)return"";const f=i.find(D=>D.ten_nv===m);return f?`${f.ten_nv} (${f.email})`:m};K(c(t.ldpcrc||"",l.ldpcrc)),P(c(t.cbcrc||"",l.cbcrc)),A(c(t.quycrc||"",l.quycrc))},de=async t=>{s({type:"",text:""});try{const{error:c}=await a.from("crc_reminders").delete().eq("id",t);if(c)throw c;s({type:"success",text:"X√≥a nh·∫Øc nh·ªü CRC th√†nh c√¥ng"}),r()}catch{s({type:"error",text:"Kh√¥ng th·ªÉ x√≥a nh·∫Øc nh·ªü CRC"})}},ue=(t,c,m,i,f)=>{const D=[m,i,f].filter(x=>x&&x!=="Ch∆∞a ch·ªçn").map(x=>`b·∫°n ${x}`);return`${D.length>0?`Xin ch√†o ${D.join(", ")}, `:"Xin ch√†o, "}C√≥ y√™u c·∫ßu duy·ªát CRC lo·∫°i ${t} c·∫ßn th·ª±c hi·ªán v√†o ng√†y ${c}, c√°c b·∫°n h√£y ho√†n th√†nh duy·ªát CRC tr∆∞·ªõc 14 gi·ªù 00 ng√†y ${c}. Tr√¢n tr·ªçng c√°m ∆°n.`},me=async(t,c,m)=>{t&&await a.from("notifications").insert({recipient_username:t,title:c,message:m,notification_type:"crc_reminder"})},W=async t=>{s({type:"",text:""});try{if(!O(t.ngay_thuc_hien)){s({type:"info",text:"Nh·∫Øc nh·ªü CRC n√†y ch∆∞a ƒë·∫øn h·∫°n"});return}const c=(x,k)=>!x||x==="Ch∆∞a ch·ªçn"?null:k.find(Q=>Q.ten_nv===x)||null,m=[c(t.ldpcrc,l.ldpcrc),c(t.cbcrc,l.cbcrc),c(t.quycrc,l.quycrc)].filter(Boolean),i=m.map(x=>`${x.email}.hvu@vietcombank.com.vn`);if(i.length===0){s({type:"error",text:"Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi nh·∫≠n email"});return}const f=`Nh·∫Øc nh·ªü duy·ªát CRC: ${t.loai_bt_crc}`,D=ue(t.loai_bt_crc,t.ngay_thuc_hien,t.ldpcrc||"Ch∆∞a ch·ªçn",t.cbcrc||"Ch∆∞a ch·ªçn",t.quycrc||"Ch∆∞a ch·ªçn"),F=await _e(i,f,D);if(F.success){const x={...t,is_sent:!0,sent_date:new Date().toISOString().split("T")[0]};delete x.id,await a.from("sent_crc_reminders").insert([x]),await a.from("crc_reminders").delete().eq("id",t.id);const k=`Y√™u c·∫ßu duy·ªát CRC lo·∫°i "${t.loai_bt_crc}" c·∫ßn th·ª±c hi·ªán v√†o ng√†y ${t.ngay_thuc_hien}.`,Q={title:"Nh·∫Øc nh·ªü duy·ªát CRC",body:k,url:"/crc-reminders"};for(const te of m)me(te.email,"Nh·∫Øc nh·ªü duy·ªát CRC",k),qe(te.email,Q);s({type:"success",text:"ƒê√£ g·ª≠i email v√† chuy·ªÉn sang danh s√°ch ƒë√£ g·ª≠i"}),r()}else throw new Error(F.error)}catch(c){s({type:"error",text:`Kh√¥ng th·ªÉ g·ª≠i email: ${c.message}`})}},xe=async()=>{s({type:"",text:""});const t=d.filter(c=>O(c.ngay_thuc_hien));if(t.length===0){s({type:"info",text:"Kh√¥ng c√≥ nh·∫Øc nh·ªü CRC n√†o ƒë·∫øn h·∫°n ho·∫∑c qu√° h·∫°n"});return}for(const c of t)await W(c)},Ce=async t=>{s({type:"",text:""});try{const{error:c}=await a.from("sent_crc_reminders").delete().eq("id",t);if(c)throw c;s({type:"success",text:"X√≥a nh·∫Øc nh·ªü ƒë√£ g·ª≠i th√†nh c√¥ng"}),r()}catch(c){s({type:"error",text:`Kh√¥ng th·ªÉ x√≥a nh·∫Øc nh·ªü ƒë√£ g·ª≠i: ${c.message}`})}},ge=async()=>{s({type:"",text:""});try{const{error:t}=await a.from("sent_crc_reminders").delete().neq("id","00000000-0000-0000-0000-000000000000");if(t)throw t;s({type:"success",text:"ƒê√£ x√≥a t·∫•t c·∫£ nh·∫Øc nh·ªü CRC ƒë√£ g·ª≠i th√†nh c√¥ng."}),r()}catch(t){s({type:"error",text:`Kh√¥ng th·ªÉ x√≥a t·∫•t c·∫£ nh·∫Øc nh·ªü CRC ƒë√£ g·ª≠i: ${t.message}`})}},Z=d.filter(t=>[t.loai_bt_crc,t.ldpcrc,t.cbcrc,t.quycrc].some(c=>c==null?void 0:c.toLowerCase().includes(S.toLowerCase()))),ee=y.filter(t=>[t.loai_bt_crc,t.ldpcrc,t.cbcrc,t.quycrc].some(c=>c==null?void 0:c.toLowerCase().includes(u.toLowerCase()))),ye=l.ldpcrc.map(t=>`${t.ten_nv} (${t.email})`),pe=l.cbcrc.map(t=>`${t.ten_nv} (${t.email})`),fe=l.quycrc.map(t=>`${t.ten_nv} (${t.email})`);return e.jsx(Re,{children:e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-12 h-12 bg-blue-100 rounded-full",children:e.jsx(Ne,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Nh·∫Øc duy·ªát CRC"}),e.jsx("p",{className:"text-gray-600",children:"Qu·∫£n l√Ω v√† g·ª≠i nh·∫Øc nh·ªü v·ªÅ vi·ªác duy·ªát CRC ƒë·∫øn h·∫°n"})]})]}),p.text&&e.jsxs(je,{variant:p.type==="error"?"destructive":"default",className:p.type==="success"?"bg-green-100 border-green-400 text-green-800":p.type==="info"?"bg-blue-100 border-blue-400 text-blue-800":"",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx(be,{children:p.text})]}),e.jsxs(M,{children:[e.jsx(U,{children:e.jsx(X,{children:"Th√™m nh·∫Øc nh·ªü CRC"})}),e.jsx(H,{children:e.jsxs("form",{onSubmit:oe,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"loaiCRC",children:"Lo·∫°i BT CRC"}),e.jsx(ce,{id:"loaiCRC",value:N,onChange:t=>T(t.target.value),placeholder:"Nh·∫≠p/xu·∫•t/m∆∞·ª£n - S·ªë - T√™n TS",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"ngayThucHien",children:"Ng√†y th·ª±c hi·ªán"}),e.jsx(ve,{value:$,onChange:B,placeholder:"26-06",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"cbcrc",children:"CBCRC"}),e.jsx(z,{value:G,onChange:P,options:pe,placeholder:"Nh·∫≠p t√™n CB l√†m CRC",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"ldpcrc",children:"LDPCRC"}),e.jsx(z,{value:Y,onChange:K,options:ye,placeholder:"Nh·∫≠p t√™n LDP duy·ªát CRC",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"quycrc",children:"QUY√áRC"}),e.jsx(z,{value:V,onChange:A,options:fe,placeholder:"Nh·∫≠p t√™n Th·ªß qu·ªπ duy·ªát CRC",className:"mt-1"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4 pt-4",children:[e.jsx(v,{type:"button",variant:"outline",onClick:J,children:"Clear"}),e.jsx(v,{type:"submit",className:"bg-blue-600 hover:bg-blue-700",disabled:g,children:"+ Th√™m nh·∫Øc nh·ªü"})]})]})})]}),e.jsxs(M,{children:[e.jsxs(U,{className:"flex flex-row items-center justify-between",children:[e.jsxs(X,{children:["Danh s√°ch ch·ªù g·ª≠i (",Z.length,")"]}),e.jsx(v,{onClick:xe,className:"bg-green-600 hover:bg-green-700",disabled:g,children:"G·ª≠i t·∫•t c·∫£"})]}),e.jsx(H,{children:e.jsx($e,{filteredReminders:Z,isLoading:g,isDayMonthDueOrOverdue:O,onSendSingleReminder:W,onEdit:he,onDelete:de})})]}),e.jsxs(M,{children:[e.jsxs(U,{className:"flex flex-row items-center justify-between",children:[e.jsxs(X,{children:["Danh s√°ch ƒë√£ g·ª≠i (",ee.length,")"]}),e.jsx(v,{onClick:ge,variant:"destructive",disabled:g,children:"X√≥a t·∫•t c·∫£"})]}),e.jsx(H,{children:e.jsx(De,{filteredSentReminders:ee,sentSearchTerm:u,setSentSearchTerm:b,isLoading:g,onDeleteSentReminder:Ce})})]})]})})};export{Ye as default};
