import{j as e,B as N,r as f,s as y,d as W}from"./index-Cfyb-cTT.js";import{I as Z,A as ue,a as xe}from"./input-DI_PInR2.js";import{L as B}from"./label-KRVLd3Sf.js";import{C as Q,c as O,a as Y,b as G}from"./index-lOgDGn8a.js";import{T as M,L as fe}from"./Layout-Bu6kW370.js";import{C as ye,D as be,a as J}from"./ComboBox-C74QWB7N.js";import{T as ee,a as te,b as R,c as j,d as ne,e as g}from"./table-B3C0REyg.js";import{C as se}from"./circle-alert-XyUDaGPe.js";import{M as ge}from"./mail-7Z1xUE3J.js";import{S as pe}from"./square-pen-PhqW0fJJ.js";import{u as je}from"./useCurrentUser-DoC6E23S.js";import{t as _e}from"./csvUtils-DYHwBSs2.js";import{a as Ce}from"./assetNotificationService-Rh4JThwE.js";import{f as Ne}from"./format-CaiECi-v.js";import{s as $}from"./notificationService-74P8wsMt.js";import"./emailUtils-C-rUDXQT.js";const ve=({filteredReminders:i,isLoading:r,onEdit:l,onDelete:h,onSendSingle:u,isDayMonthDueOrOverdue:n})=>r?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-600"})}):i.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Chưa có nhắc nhở nào"}):e.jsxs(ee,{children:[e.jsx(te,{children:e.jsxs(R,{children:[e.jsx(j,{children:"Tên TS"}),e.jsx(j,{children:"Ngày đến hạn"}),e.jsx(j,{children:"CBQLN"}),e.jsx(j,{children:"CBKH"}),e.jsx(j,{children:"Thao tác"})]})}),e.jsx(ne,{children:i.map(c=>e.jsxs(R,{children:[e.jsx(g,{className:"font-medium",children:c.ten_ts}),e.jsxs(g,{className:`${n(c.ngay_den_han)?"bg-red-100 text-red-800 font-bold":""}`,children:[c.ngay_den_han,n(c.ngay_den_han)&&e.jsx(se,{className:"w-4 h-4 inline ml-2 text-red-600"})]}),e.jsx(g,{children:c.cbqln||"Chưa chọn"}),e.jsx(g,{children:c.cbkh||"Chưa chọn"}),e.jsx(g,{children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(N,{size:"sm",variant:"outline",onClick:()=>u(c),disabled:!n(c.ngay_den_han)||r,title:"Gửi email nhắc nhở tài sản",children:e.jsx(ge,{className:"w-4 h-4"})}),e.jsx(N,{size:"sm",variant:"outline",onClick:()=>l(c),disabled:r,children:e.jsx(pe,{className:"w-4 h-4"})}),e.jsx(N,{size:"sm",variant:"destructive",onClick:()=>h(c.id),disabled:r,children:e.jsx(M,{className:"w-4 h-4"})})]})})]},c.id))})]}),Se=({filteredSentReminders:i,sentSearchTerm:r,setSentSearchTerm:l,isLoading:h,onDeleteSentReminder:u})=>h?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-600"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-4",children:e.jsx(Z,{placeholder:"Tìm kiếm trong danh sách đã gửi...",value:r,onChange:n=>l(n.target.value),className:"max-w-sm"})}),e.jsxs(ee,{children:[e.jsx(te,{children:e.jsxs(R,{children:[e.jsx(j,{children:"Tên TS"}),e.jsx(j,{children:"Ngày đến hạn"}),e.jsx(j,{children:"CBQLN"}),e.jsx(j,{children:"CBKH"}),e.jsx(j,{children:"Ngày gửi"}),e.jsx(j,{children:"Thao tác"})]})}),e.jsxs(ne,{children:[i.map(n=>e.jsxs(R,{children:[e.jsx(g,{className:"font-medium",children:n.ten_ts}),e.jsx(g,{children:n.ngay_den_han}),e.jsx(g,{children:n.cbqln||"Chưa chọn"}),e.jsx(g,{children:n.cbkh||"Chưa chọn"}),e.jsx(g,{children:n.sent_date}),e.jsx(g,{children:e.jsx(N,{size:"sm",variant:"destructive",onClick:()=>u(n.id),title:"Xóa nhắc nhở đã gửi",disabled:h,children:e.jsx(M,{className:"w-4 h-4"})})})]},n.id)),i.length===0&&e.jsx(R,{children:e.jsx(g,{colSpan:6,className:"text-center py-8 text-gray-500",children:"Chưa có email nào được gửi"})})]})]})]}),we=()=>{const[i,r]=f.useState({cbqln:[],cbkh:[],ldpcrc:[],cbcrc:[],quycrc:[]}),l=async()=>{try{const{data:h,error:u}=await y.from("cbqln").select("id, ten_nv, email");if(u)throw u;const{data:n,error:c}=await y.from("cbkh").select("id, ten_nv, email");if(c)throw c;const{data:b,error:t}=await y.from("ldpcrc").select("id, ten_nv, email");if(t)throw t;const{data:a,error:d}=await y.from("cbcrc").select("id, ten_nv, email");if(d)throw d;const{data:o,error:m}=await y.from("quycrc").select("id, ten_nv, email");if(m)throw m;r({cbqln:h||[],cbkh:n||[],ldpcrc:b||[],cbcrc:a||[],quycrc:o||[]})}catch(h){console.error("Error loading staff data:",h)}};return f.useEffect(()=>{l()},[]),{staff:i,loadStaffData:l}},ke=()=>{const[i,r]=f.useState([]),[l,h]=f.useState([]);return{reminders:i,setReminders:r,sentReminders:l,setSentReminders:h,loadReminderData:async()=>{try{console.log("Loading reminder data..."),console.log("Loading asset reminders...");const{data:n,error:c}=await y.from("asset_reminders").select("*").order("ngay_den_han",{ascending:!0});if(c)throw console.error("Asset Reminders query error:",c),new Error(`Asset Reminders load error: ${c.message}`);console.log("Asset Reminders loaded:",(n==null?void 0:n.length)||0,"records"),console.log("Loading sent asset reminders...");const{data:b,error:t}=await y.from("sent_asset_reminders").select("*").order("sent_date",{ascending:!1});if(t)throw console.error("Sent asset reminders query error:",t),new Error(`Sent asset reminders load error: ${t.message}`);return console.log("Sent asset reminders loaded:",(b==null?void 0:b.length)||0,"records"),r(n||[]),h(b||[]),{remindersData:n,sentRemindersData:b}}catch(n){throw console.error("Error loading reminder data:",n),r([]),h([]),W.error("Không thể tải dữ liệu nhắc nhở",{description:n.message}),n}}}},Re=()=>{const[i,r]=f.useState(!1),{currentUser:l}=je(),{staff:h,loadStaffData:u}=we(),{reminders:n,setReminders:c,sentReminders:b,setSentReminders:t,loadReminderData:a}=ke(),d=async()=>{r(!0);try{console.log("Starting to load asset reminder data..."),await Promise.all([u(),a()])}catch(o){console.error("Error loading asset reminder data:",o),W.error("Không thể tải dữ liệu nhắc nhở tài sản.")}finally{r(!1)}};return f.useEffect(()=>{d()},[]),{reminders:n,setReminders:c,sentReminders:b,setSentReminders:t,staff:h,currentUser:l,isLoading:i,loadData:d}},qe=(i,r)=>{const l=async(t,a,d,o,m)=>{if(!t||!a)return r({type:"error",text:"Vui lòng điền đầy đủ thông tin bắt buộc"}),!1;try{const x={ten_ts:t,ngay_den_han:a,cbkh:d||null,cbqln:o||null,is_sent:!1};if(m){const{error:_}=await y.from("asset_reminders").update(x).eq("id",m.id);if(_)throw _;r({type:"success",text:"Cập nhật nhắc nhở thành công"})}else{const{error:_}=await y.from("asset_reminders").insert([x]);if(_)throw _;r({type:"success",text:"Thêm nhắc nhở thành công"})}return await i(),!0}catch(x){return r({type:"error",text:`Không thể lưu nhắc nhở: ${x.message}`}),!1}},h=async t=>{try{const{error:a}=await y.from("asset_reminders").delete().eq("id",t);if(a)throw a;r({type:"success",text:"Xóa nhắc nhở thành công"}),await i()}catch{r({type:"error",text:"Không thể xóa nhắc nhở"})}},u=async t=>{try{const{error:a}=await y.from("sent_asset_reminders").delete().eq("id",t);if(a)throw a;r({type:"success",text:"Xóa nhắc nhở đã gửi thành công"}),await i()}catch{r({type:"error",text:"Không thể xóa nhắc nhở đã gửi"})}},n=async()=>{r({type:"info",text:""});try{const{error:t}=await y.from("sent_asset_reminders").delete().neq("id","00000000-0000-0000-0000-000000000000");if(t)throw t;r({type:"success",text:"Đã xóa tất cả nhắc nhở đã gửi thành công."}),await i()}catch(t){r({type:"error",text:`Không thể xóa tất cả nhắc nhở đã gửi: ${t.message}`})}},c=[{key:"id",label:"ID",type:"text"},{key:"ten_ts",label:"Tên tài sản",type:"text"},{key:"ngay_den_han",label:"Ngày đến hạn",type:"date"},{key:"cbkh",label:"CBKH",type:"text"},{key:"cbqln",label:"CBQLN",type:"text"},{key:"is_sent",label:"Đã gửi",type:"boolean"},{key:"created_at",label:"Ngày tạo",type:"date"}];return{handleSubmit:l,handleDelete:h,handleDeleteSentReminder:u,handleDeleteAllSentReminders:n,exportToCSV:(t,a="asset_reminders.csv")=>{if(t.length===0){r({type:"info",text:"Không có dữ liệu để xuất"});return}const d=_e(t,c),o=new Blob([d],{type:"text/csv;charset=utf-8;"}),m=document.createElement("a");if(m.download!==void 0){const x=URL.createObjectURL(o);m.setAttribute("href",x),m.setAttribute("download",a),m.style.visibility="hidden",document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(x),r({type:"success",text:`Đã xuất dữ liệu ra tệp ${a}`})}else r({type:"error",text:"Trình duyệt của bạn không hỗ trợ tải xuống tệp trực tiếp."})}}},Te=(i,r,l)=>{const[h,u]=f.useState(!1),n=t=>{const[a,d]=t.split("-").map(Number),o=new Date,m=o.getFullYear(),x=new Date(m,d-1,a);return x<o&&(o.getMonth()>d-1||o.getMonth()===d-1&&o.getDate()>a)&&x.setFullYear(m+1),o.setHours(0,0,0,0),x.setHours(0,0,0,0),x<=o},c=async t=>{u(!0);try{const a=i.cbkh.find(C=>C.ten_nv===t.cbkh),d=i.cbqln.find(C=>C.ten_nv===t.cbqln),o=[];if(a!=null&&a.email&&o.push(a.email),d!=null&&d.email&&o.push(d.email),o.length===0)return l({type:"error",text:`Không tìm thấy email người nhận cho nhắc nhở "${t.ten_ts}".`}),!1;const m=`Nhắc nhở tài sản đến hạn: ${t.ten_ts}`,x=`Tài sản "${t.ten_ts}" có ngày đến hạn là ${t.ngay_den_han}. Vui lòng kiểm tra và xử lý.`,_=await Ce(o,m,x);return _.success?(await y.from("asset_reminders").update({is_sent:!0}).eq("id",t.id),await y.from("sent_asset_reminders").insert({ten_ts:t.ten_ts,ngay_den_han:t.ngay_den_han,cbqln:t.cbqln,cbkh:t.cbkh,is_sent:!0,sent_date:Ne(new Date,"yyyy-MM-dd")}),l({type:"success",text:`Đã gửi nhắc nhở cho "${t.ten_ts}" thành công.`}),await r(),!0):(l({type:"error",text:`Không thể gửi nhắc nhở cho "${t.ten_ts}": ${_.error}`}),!1)}catch(a){return console.error("Error sending single reminder:",a),l({type:"error",text:`Lỗi khi gửi nhắc nhở cho "${t.ten_ts}": ${a.message}`}),!1}finally{u(!1)}};return{isSending:h,isDateDueOrOverdue:n,sendSingleReminder:c,sendReminders:async t=>{if(t.length===0)return l({type:"info",text:"Không có nhắc nhở nào đến hạn để gửi."}),!0;u(!0);let a=!0;for(const d of t)await c(d)||(a=!1);return u(!1),l(a?{type:"success",text:`Đã gửi tất cả ${t.length} nhắc nhở đến hạn.`}:{type:"error",text:"Có lỗi xảy ra khi gửi một số nhắc nhở."}),a}}},Ye=()=>{const[i,r]=f.useState({type:"",text:""}),l=s=>{r(s)},{reminders:h,sentReminders:u,staff:n,isLoading:c,loadData:b}=Re(),{handleSubmit:t,handleDelete:a,handleDeleteSentReminder:d,handleDeleteAllSentReminders:o}=qe(b,l),{isDateDueOrOverdue:m,sendSingleReminder:x,sendReminders:_}=Te(n,b,l),C=async(s,A,p)=>{s&&await y.from("notifications").insert({recipient_username:s,title:A,message:p,notification_type:"asset_reminder"})},re=async s=>{if(await x(s)){const p=n.cbkh.find(k=>k.ten_nv===s.cbkh),v=n.cbqln.find(k=>k.ten_nv===s.cbqln),S=`Tài sản "${s.ten_ts}" đã đến hạn.`,w={title:"Nhắc nhở tài sản đến hạn",body:S,url:"/asset-reminders"};p&&(C(p.email,"Nhắc nhở tài sản",S),$(p.email,w)),v&&(C(v.email,"Nhắc nhở tài sản",S),$(v.email,w))}},ae=async()=>{const s=h.filter(p=>m(p.ngay_den_han));if(await _(s))for(const p of s){const v=n.cbkh.find(F=>F.ten_nv===p.cbkh),S=n.cbqln.find(F=>F.ten_nv===p.cbqln),w=`Tài sản "${p.ten_ts}" đã đến hạn.`,k={title:"Nhắc nhở tài sản đến hạn",body:w,url:"/asset-reminders"};v&&(C(v.email,"Nhắc nhở tài sản",w),$(v.email,k)),S&&(C(S.email,"Nhắc nhở tài sản",w),$(S.email,k))}},[K,De]=f.useState(""),[q,ce]=f.useState(""),[ie,H]=f.useState(null),[U,T]=f.useState(""),[I,D]=f.useState(""),[V,L]=f.useState(""),[z,E]=f.useState(""),le=async s=>{s.preventDefault(),r({type:"",text:""}),await t(U,I,V,z,ie)&&(T(""),D(""),L(""),E(""),H(null))},oe=s=>{H(s),T(s.ten_ts),D(s.ngay_den_han),L(s.cbkh||""),E(s.cbqln||"")},de=()=>{H(null),T(""),D(""),L(""),E("")},X=h.filter(s=>s.ten_ts.toLowerCase().includes(K.toLowerCase())||s.cbkh&&s.cbkh.toLowerCase().includes(K.toLowerCase())||s.cbqln&&s.cbqln.toLowerCase().includes(K.toLowerCase())),P=u.filter(s=>s.ten_ts.toLowerCase().includes(q.toLowerCase())||s.cbkh&&s.cbkh.toLowerCase().includes(q.toLowerCase())||s.cbqln&&s.cbqln.toLowerCase().includes(q.toLowerCase())),he=n.cbkh.map(s=>s.ten_nv),me=n.cbqln.map(s=>s.ten_nv);return e.jsx(fe,{children:e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-12 h-12 bg-orange-100 rounded-full",children:e.jsx(ye,{className:"w-6 h-6 text-orange-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Nhắc tài sản đến hạn"}),e.jsx("p",{className:"text-gray-600",children:"Quản lý và gửi nhắc nhở về tài sản đến hạn trả"})]})]}),i.text&&e.jsxs(ue,{variant:i.type==="error"?"destructive":"default",className:i.type==="success"?"bg-green-100 border-green-400 text-green-800":i.type==="info"?"bg-blue-100 border-blue-400 text-blue-800":"",children:[e.jsx(se,{className:"h-4 w-4"}),e.jsx(xe,{children:i.text})]}),e.jsx(Q,{children:e.jsx(O,{className:"pt-6",children:e.jsxs("form",{onSubmit:le,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(B,{htmlFor:"tenTaiSan",children:"Tên tài sản"}),e.jsx(Z,{id:"tenTaiSan",value:U,onChange:s=>T(s.target.value),placeholder:"Nhập tên TS",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(B,{htmlFor:"ngayDenHan",children:"Ngày đến hạn"}),e.jsx(be,{value:I,onChange:D,placeholder:"dd-MM",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(B,{htmlFor:"cbqln",className:"text-blue-600 font-medium",children:"CBQLN"}),e.jsx(J,{value:z,onChange:E,options:me,placeholder:"Chọn nhân viên QLN",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(B,{htmlFor:"cbkh",className:"text-red-600 font-medium",children:"CBKH"}),e.jsx(J,{value:V,onChange:L,options:he,placeholder:"Chọn nhân viên KH",className:"mt-1"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4 pt-4",children:[e.jsx(N,{type:"button",variant:"outline",onClick:de,children:"Clear"}),e.jsx(N,{type:"submit",className:"bg-orange-600 hover:bg-orange-700",disabled:c,children:"+ Thêm nhắc nhở"})]})]})})}),e.jsxs(Q,{children:[e.jsxs(Y,{className:"flex flex-row items-center justify-between",children:[e.jsxs(G,{children:["Danh sách nhắc nhở (",X.length,")"]}),e.jsx(N,{onClick:ae,className:"bg-green-600 hover:bg-green-700",disabled:c,children:"Gửi email"})]}),e.jsx(O,{children:e.jsx(ve,{filteredReminders:X,isLoading:c,onEdit:oe,onDelete:a,onSendSingle:re,isDayMonthDueOrOverdue:m})})]}),e.jsxs(Q,{children:[e.jsxs(Y,{className:"flex flex-row items-center justify-between",children:[e.jsxs(G,{children:["Danh sách đã gửi (",P.length,")"]}),e.jsx(N,{onClick:o,variant:"destructive",disabled:c,children:"Xóa tất cả"})]}),e.jsx(O,{children:e.jsx(Se,{filteredSentReminders:P,sentSearchTerm:q,setSentSearchTerm:ce,isLoading:c,onDeleteSentReminder:d})})]})]})})};export{Ye as default};
